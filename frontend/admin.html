<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Ask iQueue</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            margin-top: 20px;
        }
        .admin-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            color: #4a5568;
            font-weight: 500;
        }
        .admin-tab.active {
            background: #667eea;
            color: white;
        }
        .admin-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .admin-section.active {
            display: block;
        }
        .prompt-editor {
            width: 100%;
            height: 300px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            resize: vertical;
            outline: none;
        }
        .prompt-editor:focus {
            border-color: #667eea;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .document-analytics {
            max-height: 400px;
            overflow-y: auto;
        }
        .document-card {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .document-card:hover {
            border-color: #667eea;
            transform: translateY(-1px);
        }
        .document-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }
        .document-title {
            font-weight: 600;
            color: #2d3748;
        }
        .document-meta {
            font-size: 14px;
            color: #718096;
            margin-bottom: 10px;
        }
        .document-actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
        }
        .btn-danger {
            background: #f56565;
            color: white;
        }
        .btn-danger:hover {
            background: #e53e3e;
        }
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .success-message {
            background: #c6f6d5;
            color: #2d7d32;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .upload-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .upload-section,
        .documents-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f7fafc;
        }
        .upload-area:hover,
        .upload-area.drag-over {
            border-color: #667eea;
            background: #edf2f7;
        }
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .upload-area p {
            margin-bottom: 10px;
            color: #4a5568;
        }
        .file-types {
            font-size: 14px;
            color: #718096;
        }
        .upload-progress {
            margin-top: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s ease;
            animation: pulse 2s infinite;
        }
        .progress-text {
            text-align: center;
            color: #4a5568;
            font-weight: 500;
        }
        .documents-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .document-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .document-item:hover {
            border-color: #667eea;
            transform: translateY(-1px);
        }
        .document-info {
            flex: 1;
        }
        .document-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }
        .document-meta {
            font-size: 14px;
            color: #718096;
        }
        .document-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        @media (max-width: 768px) {
            .upload-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Admin Panel -->
        <div class="admin-container" id="adminContainer">
            
            <header>
                <h1>ü§ñ Ask iQueue</h1>
                <nav>
                    <a href="index.html" class="nav-link">Chat</a>
                    <a href="admin.html" class="nav-link active">Admin</a>
                </nav>
                <nav class="admin-tabs">
                    <div class="admin-tab active" data-tab="documents">Documents & Upload</div>
                    <div class="admin-tab" data-tab="system-prompt">System Prompt</div>
                </nav>
            </header>


            <!-- System Prompt Section -->
            <div class="admin-section" id="system-prompt">
                <h2>üí¨ System Prompt</h2>
                <div id="promptMessage" style="display: none;"></div>
                <div class="form-group">
                    <label class="form-label" for="systemPrompt">System Prompt</label>
                    <p style="font-size: 14px; color: #718096; margin-bottom: 10px;">
                        ‚ÑπÔ∏è Note: Markdown formatting instructions are automatically appended to ensure proper response formatting.
                    </p>
                    <textarea id="systemPrompt" class="prompt-editor" placeholder="Loading system prompt..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="savePromptBtn" class="btn btn-primary">Save Changes</button>
                    <button id="resetPromptBtn" class="btn btn-secondary">Reset to Default</button>
                </div>
            </div>

            <!-- Documents & Upload Section -->
            <div class="admin-section active" id="documents">
                <div class="upload-container">
                    <div class="upload-section">
                        <h2>üìÑ Upload Documents</h2>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">üìÑ</div>
                            <p>Drag and drop files here or click to browse</p>
                            <p class="file-types">Supported: PDF, TXT files</p>
                            <input type="file" id="fileInput" accept=".pdf,.txt" multiple style="display: none;">
                        </div>
                        
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">Uploading...</div>
                        </div>
                    </div>

                    <div class="documents-section">
                        <h2>Uploaded Documents</h2>
                        <div id="documentMessage" style="display: none;"></div>
                        <div class="documents-list" id="documentsList">
                            <div class="loading">Loading documents...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        class AdminPanel {
            constructor() {
                this.currentTab = 'documents';
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadSystemPrompt();
                await this.loadDocuments();
            }

            setupEventListeners() {
                // Upload functionality
                this.setupUploadHandlers();

                // Tab switching
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // Save prompt button
                document.getElementById('savePromptBtn').addEventListener('click', () => this.saveSystemPrompt());

                // Reset prompt button
                document.getElementById('resetPromptBtn').addEventListener('click', () => this.resetSystemPrompt());
            }

            setupUploadHandlers() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');

                // Click to browse
                uploadArea.addEventListener('click', () => fileInput.click());

                // Drag and drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    this.handleFiles(e.dataTransfer.files);
                });

                // File input change
                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });
            }


            switchTab(tabName) {
                // Switch tab appearance
                document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.admin-section').forEach(section => section.classList.remove('active'));
                
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(tabName).classList.add('active');
                
                this.currentTab = tabName;

            }

            async loadSystemPrompt() {
                try {
                    const response = await fetch(`${API_BASE}/admin/system-prompt`);

                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('systemPrompt').value = data.system_prompt;
                    }
                } catch (error) {
                    console.error('Error loading system prompt:', error);
                }
            }

            async saveSystemPrompt() {
                const prompt = document.getElementById('systemPrompt').value;
                const messageDiv = document.getElementById('promptMessage');

                try {
                    const response = await fetch(`${API_BASE}/admin/system-prompt`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt })
                    });

                    if (response.ok) {
                        messageDiv.className = 'success-message';
                        messageDiv.textContent = 'System prompt updated successfully!';
                        messageDiv.style.display = 'block';
                        setTimeout(() => messageDiv.style.display = 'none', 3000);
                    } else {
                        throw new Error('Failed to save prompt');
                    }
                } catch (error) {
                    messageDiv.className = 'error-message';
                    messageDiv.textContent = 'Error saving system prompt';
                    messageDiv.style.display = 'block';
                    setTimeout(() => messageDiv.style.display = 'none', 3000);
                }
            }

            resetSystemPrompt() {
                const defaultPrompt = `You are a helpful assistant that answers questions based on the provided context. 
Use the context information to provide accurate and relevant answers. If the context doesn't contain 
enough information to answer the question, say so clearly. Always be truthful and don't make up information.`;
                
                document.getElementById('systemPrompt').value = defaultPrompt;
            }

            async loadDocuments() {
                const container = document.getElementById('documentsList');
                
                try {
                    const response = await fetch(`${API_BASE}/documents/`);

                    if (response.ok) {
                        const documents = await response.json();
                        
                        if (documents.length === 0) {
                            container.innerHTML = '<div class="no-documents">No documents uploaded yet.</div>';
                            return;
                        }

                        container.innerHTML = documents.map(doc => `
                            <div class="document-item">
                                <div class="document-info">
                                    <div class="document-name">${doc.filename}</div>
                                    <div class="document-meta">
                                        ${doc.file_type.toUpperCase()} ‚Ä¢ ${doc.chunks_count} chunks ‚Ä¢ 
                                        ${new Date(doc.created_at).toLocaleDateString()}
                                    </div>
                                </div>
                                <div class="document-actions">
                                    <button class="btn btn-danger" onclick="adminPanel.deleteDocument(${doc.id}, '${doc.filename}')">Delete</button>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    container.innerHTML = '<div class="error">Error loading documents</div>';
                }
            }

            async handleFiles(files) {
                for (let file of files) {
                    if (file.type === 'application/pdf' || file.type === 'text/plain') {
                        await this.uploadFile(file);
                    } else {
                        alert(`Unsupported file type: ${file.name}`);
                    }
                }
            }

            async uploadFile(file) {
                const formData = new FormData();
                formData.append('file', file);

                const uploadProgress = document.getElementById('uploadProgress');
                const progressText = document.getElementById('progressText');

                uploadProgress.style.display = 'block';
                progressText.textContent = `Uploading ${file.name}...`;

                try {
                    const response = await fetch(`${API_BASE}/documents/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        progressText.textContent = `‚úÖ ${file.name} uploaded successfully!`;
                        setTimeout(() => {
                            uploadProgress.style.display = 'none';
                            this.loadDocuments();
                        }, 2000);
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    progressText.textContent = `‚ùå Error uploading ${file.name}`;
                    console.error('Upload error:', error);
                    setTimeout(() => {
                        uploadProgress.style.display = 'none';
                    }, 3000);
                }
            }

            async deleteDocument(docId, filename) {
                if (!confirm(`Are you sure you want to delete "${filename}"?`)) return;

                const messageDiv = document.getElementById('documentMessage');

                try {
                    const response = await fetch(`${API_BASE}/documents/${docId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        messageDiv.className = 'success-message';
                        messageDiv.textContent = `Document "${filename}" deleted successfully`;
                        messageDiv.style.display = 'block';
                        setTimeout(() => messageDiv.style.display = 'none', 3000);
                        await this.loadDocuments();
                    } else {
                        throw new Error('Delete failed');
                    }
                } catch (error) {
                    messageDiv.className = 'error-message';
                    messageDiv.textContent = 'Error deleting document';
                    messageDiv.style.display = 'block';
                    setTimeout(() => messageDiv.style.display = 'none', 3000);
                }
            }
        }

        // Initialize admin panel
        const adminPanel = new AdminPanel();
    </script>
</body>
</html>